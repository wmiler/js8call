name: JS8Call Windows CI build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config: 
         - { name: "Windows-x64", WIN_ARCH: "x64", os: windows-2025, QT_INST_DIR: "C:/", QTDIR: "C:/Qt/6.6.3/msvc2019_64", QT_ARCH: win64_msvc2019_64, boost_dl: "${{ github.workspace }}\\downloads\\boost", lib_dir: "C:\\Libraries", generators: Ninja }
            
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          
      - name: Print env
        run: |
          echo github.event.action: ${{ github.event.action }}
          echo github.event_name: ${{ github.event_name }}
          echo github.ref: ${{ github.ref }}
          echo github.workspace: ${{ github.workspace }}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install basic dependencies on Windows
        if: startsWith(matrix.config.os, 'windows')
        run: |
          choco install ninja cmake
          ninja --version
          cmake --version
          
      - name: Install MSVC on Windows
        if: startsWith(matrix.config.os, 'windows')
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

#      - name: Install boost
#        uses: MarkusJx/install-boost@v2.5.0
#        id: install-boost
#        with:
#          boost_version: 1.88.0
          # OPTIONAL: Specify a platform version
#          platform_version: 2025
          # OPTIONAL: Specify a toolset
#          toolset: msvc

      - name: Install Boost 1.88
        id: install-boost
        run: |
          cd ${{ matrix.config.lib_dir }}
          curl --location --output ${{ matrix.config.lib_dir }} https://github.com/MarkusJx/prebuilt-boost/releases/download/1.88.0/boost-1.88.0-windows-2025-msvc-shared-x86.tar.gz
          tar zxf boost-1.88.0-windows-2025-msvc-shared-x86.tar.gz
          ls -l ${{ matrix.config.lib_dir }}
          echo "BOOST_ROOT=${{ matrix.config.lib_dir }}\boost" >> $GITHUB_OUTPUT:
        
          
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.3'
          dir: ${{matrix.config.QT_INST_DIR}}
          arch: ${{matrix.config.QT_ARCH}}
          setup-python: 'false'
          modules: 'qtactiveqt qtmultimedia qtserialport'

      - name: Install OmniRig
        run: |
          winget install --id=AfreetSoftware.OmniRig -e --accept-source-agreements

      - name: Install fftw3
        run: |
          curl --location --output ${{ matrix.config.lib_dir }}/fftw-3.3.5-dll64.zip https://fftw.org/pub/fftw/fftw-3.3.5-dll64.zip
          cd ${{ matrix.config.lib_dir }}
          unzip fftw-3.3.5-dll64.zip
          env: 
            fftw3: ${{ matrix.config.lib_dir }}\fftw-3.3.5-dll64

      - name: Build js8call on Windows
        if: startsWith(matrix.config.os, 'windows')
        env: 
          BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}
        run: |
          cmd "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          choco install patch
          mkdir build && cd build
          cmake .. -DCMAKE_FIND_DEBUG_MODE=1 -G "${{ matrix.config.generators }}" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="C:\Qt\6.6.3\msvc2019_64;C:\Program Files (x86)\Afreet\OmniRig" \
          -DBoost_INCLUDE_DIR=${{ matrix.config.lib_dir }}/boost/include \
          -DBoost_LIBRARY_DIRS=${{ matrix.config.lib_dir }}/boost/lib
          
          cmake --build . --config Release --target package
          
      - name: Check disk space
        run: Get-PSDrive
        
      - name: Get version
        id: get_version
        working-directory: ${{ github.workspace }}/build
        run: echo "version=$(grep 'CPACK_PACKAGE_VERSION ' CPackConfig.cmake |cut -d '"' -f2 |cut -d '"' -f1 >> $env:GITHUB_OUTPUT
        
      - name: Upload unsigned artifact
        id: upload-unsigned-artifact
        uses: actions/upload-artifact@v4
        with:
          name: js8call-${{ steps.get_version.outputs.version }}-win64.exe
          path: ${{ github.workspace }}/build/js8call-${{ steps.get_version.outputs.version }}-win64.exe
          
#      - name: Sign Code
#        id: sign_code
#        uses: signpath/github-action-submit-signing-request@v1
#        with:
#          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
#          organization-id: '553b8f53-adf0-4fe5-be3d-283504a21a51'
#          project-slug: 'js8call'
#          signing-policy-slug: 'release-signing'
#          github-artifact-id: '${{ steps.upload-unsigned-artifact.outputs.artifact-id }}'
#          wait-for-completion: true
#          output-artifact-directory: 'build\signed'
#          wait-for-completion-timeout-in-seconds: 3600
#      - name: Upload signed artifact
#        id: upload-signed-artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: js8call-${{ steps.get_version.outputs.version }}-win64-signed.exe
#          path: ${{ github.workspace }}/build/signed/js8call-${{ steps.get_version.outputs.version }}-win64.exe
#      - name: Upload release
#        if: startsWith(github.ref, 'refs/tags/')
#        uses: softprops/action-gh-release@v2
#        with:
#          files: ${{ github.workspace }}/build/signed/js8call-${{ steps.get_version.outputs.version }}-win64.exe
